<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Just A Caffeinated Widget</title>
    <style>
        iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            border: none;
        }
    </style>
</head>

<body></body>

<footer>
    <script>
        const queryParams = (() => {
            let vars = {};

            location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, (m, key, value) => {
                vars[key] = value;
            });

            return vars;
        })();

        const {
            pluginId,
            widgetId,
            authorization
        } = queryParams;
        const port = queryParams.port || "8092";
        const address = queryParams.address || "127.0.0.1";
        const widgetMode = (queryParams.mode || "WIDGET").toUpperCase();

        const sandboxFrame = document.createElement("iframe");

        window.addEventListener(
            "message",
            (event) => {
                if (event.data.call == "reload") {
                    location.reload();
                }
            },
            false
        );

        (async() => {
            try {
                const response = await fetch(`http://${address}:${port}/api/plugin/${pluginId}/widget/${widgetId}/webapp?authorization=${authorization}&mode=${widgetMode}`);

                const {
                    data
                } = await response.json();

                if (data) {
                    sandboxFrame.src = `${data.url}${location.search}&kickstart=${data.kickstart}`;
                } else {
                    setTimeout(() => location.reload(), 2500);
                }

                document.body.appendChild(sandboxFrame);
            } catch (e) {
                console.error(e);
                setTimeout(() => location.reload(), 2500);
            }
        })();
    </script>
</footer>

</html>