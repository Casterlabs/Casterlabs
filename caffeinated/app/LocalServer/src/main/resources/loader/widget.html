<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Just A Caffeinated Widget</title>
        <style>
            iframe {
                position: absolute;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                border: none;
            }
        </style>
    </head>

    <body>
        <iframe id="iframe" src="about:blank"></iframe>
    </body>

    <footer>
        <!-- type="module" helps isolate. -->
        <script type="module">
            import { init, deepFreeze, escapeHtml } from "./widget.mjs";
            let initParameters;

            const sandboxFrame = document.getElementById("iframe");

            function tryInject() {
                const { conn, koiInstance, widgetInstance, musicInstance, Currencies, koi_statics, address, port, pluginId, widgetId, authorization, widgetMode, App } = initParameters;
                const { contentWindow, contentDocument } = sandboxFrame;

                if (!contentWindow.Koi) {
                    // Inject our f a v o r i t e globals.
                    Object.defineProperty(contentWindow, "Koi", {
                        value: koiInstance,
                        writable: false,
                        configurable: false
                    });
                    Object.defineProperty(contentWindow, "Widget", {
                        value: widgetInstance,
                        writable: false,
                        configurable: false
                    });
                    Object.defineProperty(contentWindow, "Music", {
                        value: musicInstance,
                        writable: false,
                        configurable: false
                    });
                    Object.defineProperty(contentWindow, "escapeHtml", {
                        value: escapeHtml,
                        writable: false,
                        configurable: false
                    });
                    Object.defineProperty(contentWindow, "Currencies", {
                        value: Currencies,
                        writable: false,
                        configurable: false
                    });
                    Object.defineProperty(contentWindow, "App", {
                        value: App,
                        writable: false,
                        configurable: false
                    });

                    widgetInstance.broadcast("init");
                    koiInstance.broadcast("koi_statics", koi_statics);
                    conn.send("READY", {});

                    contentWindow.addEventListener("load", () => {
                        console.log("[Widget Loader]", "contentWindow has loaded.");
                        App.init(contentDocument);
                    });
                }
            }

            function hook() {
                const { contentWindow, contentDocument } = sandboxFrame;

                contentWindow.addEventListener("unload", () => {
                    console.log("[Widget Loader]", "Detected contentWindow unload, hijacking...");
                    setTimeout(tryInject, 0); // Wait for the next browser tick.
                });
            }
            hook();

            function initHandler(params) {
                initParameters = params;
                const { address, port, pluginId, widgetId, authorization, widgetMode, basePath } = params;
                sandboxFrame.src = `http://${address}:${port}/api/plugin/${pluginId}/${authorization}/html${basePath}`;
            }

            init({ initHandler });
        </script>
    </footer>
</html>
